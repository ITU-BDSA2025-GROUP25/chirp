@page "/"
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Chirp.Razor
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@model Chirp.Razor.Pages.PublicModel

@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
}

<div>
    <h2> Public Timeline </h2>

    @if (SignInManager.IsSignedIn(User))
    {
        <a href="/private">Private Timeline</a>

        <!-- Share box inside UL -->
        <ul class="cheeps">
            <li class="cheepbox">
                <h3>What's on your mind @(User.Identity!.Name)?</h3>

                <form method="post">
                    <input type="hidden" name="currentPage" value="@Model.CurrentPage"/>

                    <!-- input from user with live counter -->
                    <input type="text"
                           asp-for="Text"
                           id="cheepInput"
                           maxlength="160"
                           oninput="updateCounter()"
                           style="width:100%;"/>

                    <div id="charCounter" style="font-size:0.9em; color:gray;">
                        0 / 160 characters
                    </div>

                    <input type="submit" value="Share" class="btn btn-primary" />
                </form>
            </li>
        </ul>
    }

    @if (Model.Cheeps.Any())
    {
        <ul id="messagelist" class="cheeps">
            @foreach (var cheep in Model.Cheeps)
            {
                <li class="cheepbox">
                    <div class="cheep-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <strong>
                            <a href="/@cheep.AuthorName">@cheep.AuthorName</a>
                        </strong>

                        @* FOLLOW / UNFOLLOW *@
                        @if (User.Identity!.IsAuthenticated && User.Identity!.Name != cheep.AuthorName)
                        {
                            if (Model.Following.Contains(cheep.AuthorName))
                            {
                                <form method="post"
                                      asp-page-handler="Unfollow"
                                      asp-route-user="@cheep.AuthorName"
                                      style="display:inline;">
                                    <input type="hidden" name="currentPage" value="@Model.CurrentPage"/>
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-secondary">Unfollow</button>
                                </form>
                            }
                            else
                            {
                                <form method="post"
                                      asp-page-handler="Follow"
                                      asp-route-user="@cheep.AuthorName"
                                      style="display:inline;">
                                    <input type="hidden" name="currentPage" value="@Model.CurrentPage"/>
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-primary">Follow</button>
                                </form>
                            }
                        }
                    </div>

                    <p class="cheep-message">@cheep.Message</p>
                    <small>— @cheep.Timestamp</small>

                    @* LIKE / UNLIKE *@
                    @if (User.Identity!.IsAuthenticated)
                    {
                        <div class="cheep-actions">

                            @if (cheep.HasLiked)
                            {
                                <form method="post"
                                      asp-page-handler="Unlike"
                                      asp-route-cheepId="@cheep.CheepId"
                                      style="display:inline;">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-warning">👎 Unlike</button>
                                </form>
                            }
                            else
                            {
                                <form method="post"
                                      asp-page-handler="Like"
                                      asp-route-cheepId="@cheep.CheepId"
                                      style="display:inline;">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-success">👍 Like</button>
                                </form>
                            }

                            <span>(@cheep.LikeCount likes)</span>
                        </div>
                    }

                </li>
            }
        </ul>

        <!--  PAGINATION -->
        <div style="margin-top:20px; display:flex; align-items:center; gap:12px;">

            @* PREVIOUS BUTTON *@
            @if (Model.CurrentPage > 1)
            {
                <form method="post" action="/?handler=Prev">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="currentPage" value="@Model.CurrentPage" />
                    <button type="submit" class="btn btn-secondary">⬅ Previous</button>
                </form>
            }

            <span>Page @Model.CurrentPage</span>

            @* NEXT BUTTON *@
            @if (Model.HasMorePages)
            {
                <form method="post" action="/?handler=Next">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="currentPage" value="@Model.CurrentPage" />
                    <button type="submit" class="btn btn-primary">Next ➡</button>
                </form>
            }
        </div>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }
</div>

<!-- char counter script -->
<script>
    function updateCounter() {
        const input = document.getElementById("cheepInput");
        const counter = document.getElementById("charCounter");

        const used = input.value.length;
        const limit = 160;
        const remaining = limit - used;

        counter.textContent = `${used} / ${limit} characters`;

        //no words left turn to red
        if (remaining <= 0) {
            counter.style.color = "red";
        } 
        else if (remaining < 20) {
            counter.style.color = "orange";
        } 
        else {
            counter.style.color = "gray";
        }
    }
</script>
